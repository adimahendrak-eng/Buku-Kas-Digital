<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Kas Digital Kadek Adi Mahendra (Responsif)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for the optional simple graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load jsPDF and autoTable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <style>
        /* Menggunakan font Inter dan memastikan body penuh */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Penyesuaian agar tabel di ponsel tidak terlalu lebar */
        #transaction-table-body td, #transaction-table-body th {
            padding-left: 0.5rem; /* px-2 */
            padding-right: 0.5rem; /* px-2 */
        }
        /* Custom scrollbar untuk tampilan yang lebih halus */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* Penting untuk scrollbar horizontal */
        }
        ::-webkit-scrollbar-track {
            background: #f7f9fb;
        }
        ::-webkit-scrollbar-thumb {
            background: #aab8c2;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8e9ca8;
        }
        /* Style untuk modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 100;
        }
    </style>
</head>
<body>

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen py-4 px-2 sm:py-8 sm:px-4 lg:px-8">
        <header class="mb-6 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Buku Kas Digital Kadek Adi Mahendra</h1>
            <p class="text-md sm:text-lg text-gray-500 mt-1">Catat pemasukan dan pengeluaran harian Anda</p>
        </header>

        <!-- Dashboard Ringkasan Keuangan Utama (4 kolom di desktop, 2 kolom di HP) -->
        <section id="dashboard" class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 max-w-7xl mx-auto">
            <!-- Total Pemasukan Card -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-l-4 border-green-500 transition hover:shadow-xl">
                <h2 class="text-xs sm:text-sm font-medium text-gray-500 truncate">Total Pemasukan (Global)</h2>
                <p id="total-income" class="text-lg sm:text-3xl font-bold text-green-600 mt-1">Rp 0</p>
            </div>

            <!-- Total Pengeluaran Card -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-l-4 border-red-500 transition hover:shadow-xl">
                <h2 class="text-xs sm:text-sm font-medium text-gray-500 truncate">Total Pengeluaran (Global)</h2>
                <p id="total-expense" class="text-lg sm:text-3xl font-bold text-red-600 mt-1">Rp 0</p>
            </div>

            <!-- Total Saldo Global Card -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-l-4 border-blue-500 transition hover:shadow-xl">
                <h2 class="text-xs sm:text-sm font-medium text-gray-500 truncate">Total Saldo (Global)</h2>
                <p id="total-balance" class="text-lg sm:text-3xl font-bold text-blue-600 mt-1">Rp 0</p>
            </div>
            
            <!-- Informasi Saldo Periodik Card -->
            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border-l-4 border-gray-300 transition hover:shadow-xl">
                <h2 class="text-xs sm:text-sm font-medium text-gray-500 truncate">Info Saldo Periodik</h2>
                <p class="text-lg sm:text-3xl font-bold text-gray-600 mt-1">Lihat Detail</p>
            </div>
        </section>

        <!-- Saldo Detail Mingguan dan Bulanan (2 kolom di desktop, 1 kolom di HP) -->
        <section id="detail-balances" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 max-w-7xl mx-auto">
            <!-- Saldo Mingguan Card -->
            <div class="bg-yellow-50 p-4 sm:p-6 rounded-xl shadow-lg border-l-4 border-yellow-500 transition hover:shadow-xl">
                <h2 class="text-sm font-medium text-yellow-700">Saldo Aktif Mingguan (7 Hari Terakhir)</h2>
                <p id="weekly-balance" class="text-2xl sm:text-3xl font-bold text-yellow-800 mt-1">Rp 0</p>
                <p class="text-xs text-yellow-600 mt-1">Dihitung dari Pemasukan Mingguan & Pengeluaran Harian</p>
            </div>

            <!-- Saldo Bulanan Card -->
            <div class="bg-indigo-50 p-4 sm:p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 transition hover:shadow-xl">
                <h2 class="text-sm font-medium text-indigo-700">Saldo Aktif Bulanan (30 Hari Terakhir)</h2>
                <p id="monthly-balance" class="text-2xl sm:text-3xl font-bold text-indigo-800 mt-1">Rp 0</p>
                <p class="text-xs text-indigo-600 mt-1">Dihitung dari Pemasukan Bulanan & Pengeluaran Utama</p>
            </div>
        </section>


        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
            <!-- Form Input Transaksi (Selalu di kolom pertama) -->
            <!-- sticky top-4/8 agar form tetap terlihat di HP saat scroll jika layar besar -->
            <div class="lg:col-span-1 bg-white p-4 sm:p-6 rounded-xl shadow-lg lg:h-fit lg:sticky lg:top-8 order-2 lg:order-1">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Input Transaksi Baru</h2>
                <form id="transaction-form" class="space-y-4">
                    <input type="hidden" id="transaction-id" value="">

                    <!-- Jenis Transaksi -->
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Jenis</label>
                        <select id="type" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                            <option value="income">Pemasukan</option>
                            <option value="expense">Pengeluaran</option>
                        </select>
                    </div>

                    <!-- Nominal -->
                    <div>
                        <label for="nominal" class="block text-sm font-medium text-gray-700 mb-1">Nominal (Rp)</label>
                        <input type="number" id="nominal" required min="1" placeholder="Masukkan jumlah uang" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    </div>

                    <!-- Tanggal -->
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                        <input type="date" id="date" required value="" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                    </div>

                    <!-- Kategori -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                        <select id="category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition text-sm">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>

                    <!-- Catatan -->
                    <div>
                        <label for="note" class="block text-sm font-medium text-gray-700 mb-1">Catatan (Opsional)</label>
                        <textarea id="note" rows="2" placeholder="Detail transaksi..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition text-sm"></textarea>
                    </div>

                    <!-- Tombol Simpan/Update -->
                    <button type="submit" id="submit-button" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 text-sm">
                        Simpan Transaksi
                    </button>
                    <button type="button" id="cancel-edit-button" class="hidden w-full py-2 px-4 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-150 mt-2 text-sm">
                        Batal Edit
                    </button>
                </form>
            </div>

            <!-- Daftar Transaksi dan Grafik (Selalu di kolom kedua di desktop, di atas form di HP) -->
            <div class="lg:col-span-2 order-1 lg:order-2">
                <!-- Grafik Sederhana -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 sm:mb-8">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Visualisasi Pengeluaran per Kategori</h2>
                    <div class="h-64 sm:h-80">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
                
                <!-- Tombol Download PDF -->
                <div class="flex justify-end mb-4">
                    <button id="download-pdf-button" class="px-3 py-2 sm:px-4 sm:py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 flex items-center text-sm sm:text-base">
                        <!-- Icon SVG untuk Download -->
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Download Laporan (PDF)
                    </button>
                </div>

                <!-- Tabel Transaksi -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Daftar Transaksi</h2>

                    <!-- Overflow-x-auto untuk scroll horizontal di HP jika tabel terlalu lebar -->
                    <div id="transaction-list-container" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[10%] min-w-[50px]">Tgl</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[25%] min-w-[100px]">Catatan</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[20%] min-w-[80px]">Kategori</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[25%] min-w-[120px]">Nominal</th>
                                    <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[20%] min-w-[100px]">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Transaction rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="no-transactions-message" class="text-center text-gray-500 py-4 hidden">Belum ada transaksi yang dicatat.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-modal" class="fixed inset-0 hidden modal-overlay items-center justify-center p-4" onclick="closeDeleteModal()">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Konfirmasi Hapus</h3>
            <p class="text-gray-600 mb-6 text-sm">Apakah Anda yakin ingin menghapus transaksi ini? Aksi ini tidak bisa dibatalkan.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">Batal</button>
                <button type="button" id="confirm-delete-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm">Hapus</button>
            </div>
        </div>
    </div>


    <script>
        // --- KONFIGURASI APLIKASI ---
        const LOCAL_STORAGE_KEY = 'financialData';
        
        // Kategori yang akan ditampilkan di dropdown (datar)
        const CATEGORIES = {
            income: ['Pemasukan Bulanan', 'Pemasukan Mingguan', 'Investasi', 'Hadiah', 'Lain-lain'],
            // Kategori Pengeluaran (Datar)
            expense: [
                'Makan Harian', 'Transportasi', 'Belanja Kebutuhan Harian', 
                'Tagihan', 'Sewa/Cicilan', 'Hiburan', 'Kesehatan', 'Pendidikan', 'Lain-lain'
            ]
        };

        // Kategori yang dianggap sebagai "Bulanan" atau "Mingguan" untuk perhitungan saldo spesifik
        const MONTHLY_INCOME_CATS = ['Pemasukan Bulanan'];
        const WEEKLY_INCOME_CATS = ['Pemasukan Mingguan'];
        
        // Pemetaan Kategori Pengeluaran untuk Saldo Periodik
        const EXPENSE_GROUPS = {
            // Pengeluaran yang biasanya terjadi harian/mingguan
            WEEKLY: ['Makan Harian', 'Transportasi', 'Belanja Kebutuhan Harian', 'Hiburan'],
            // Pengeluaran yang biasanya terjadi bulanan/utama
            MONTHLY: ['Tagihan', 'Sewa/Cicilan', 'Kesehatan', 'Pendidikan', 'Lain-lain']
        };


        let transactions = [];
        let categoryChart;

        // --- UTILITY FUNCTIONS ---

        /**
         * Mengonversi angka menjadi format mata uang Rupiah (Rp).
         * @param {number} number - Angka nominal.
         * @returns {string} Format mata uang.
         */
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        /**
         * Mendapatkan data dari localStorage.
         */
        const loadTransactions = () => {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            transactions = data ? JSON.parse(data) : [];
            // Urutkan berdasarkan tanggal terbaru
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        };

        /**
         * Menyimpan data ke localStorage.
         */
        const saveTransactions = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(transactions));
        };

        /**
         * Mengisi pilihan kategori pada form.
         */
        const populateCategories = () => {
            const categorySelect = document.getElementById('category');
            const typeSelect = document.getElementById('type');

            const selectedType = typeSelect.value;
            const availableCategories = CATEGORIES[selectedType] || [];

            // Kosongkan dan isi ulang pilihan
            categorySelect.innerHTML = '<option value="" disabled selected>Pilih Kategori</option>';
            
            // Tambahkan optgroup untuk pengeluaran agar lebih terstruktur
            if (selectedType === 'expense') {
                const optgroupMonthly = document.createElement('optgroup');
                optgroupMonthly.label = 'Pengeluaran Utama (Bulanan)';
                EXPENSE_GROUPS.MONTHLY.forEach(cat => {
                    if (availableCategories.includes(cat)) {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        optgroupMonthly.appendChild(option);
                    }
                });
                categorySelect.appendChild(optgroupMonthly);

                const optgroupWeekly = document.createElement('optgroup');
                optgroupWeekly.label = 'Pengeluaran Harian (Mingguan)';
                EXPENSE_GROUPS.WEEKLY.forEach(cat => {
                     if (availableCategories.includes(cat)) {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        optgroupWeekly.appendChild(option);
                    }
                });
                categorySelect.appendChild(optgroupWeekly);

            } else {
                // Untuk pemasukan, tampilkan datar
                availableCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            }
        };

        // --- DASHBOARD AND CHART FUNCTIONS ---

        /**
         * Memperbarui ringkasan keuangan di dashboard.
         */
        const updateDashboard = () => {
            let totalIncome = 0;
            let totalExpense = 0;

            const now = new Date();
            // Hitung tanggal batas untuk mingguan (7 hari) dan bulanan (30 hari)
            const oneWeekAgo = new Date(now);
            oneWeekAgo.setDate(now.getDate() - 7);
            const oneMonthAgo = new Date(now);
            oneMonthAgo.setDate(now.getDate() - 30);
            
            // Variabel untuk saldo spesifik
            let weeklyBalance = 0;
            let monthlyBalance = 0;

            // Inisialisasi Saldo dengan Pemasukan Periodik
            transactions.forEach(t => {
                if (t.type === 'income') {
                    if (WEEKLY_INCOME_CATS.includes(t.category)) {
                        weeklyBalance += t.nominal;
                    }
                    if (MONTHLY_INCOME_CATS.includes(t.category)) {
                        monthlyBalance += t.nominal;
                    }
                }
            });


            transactions.forEach(t => {
                const transactionDate = new Date(t.date);
                const isExpense = t.type === 'expense';

                // --- GLOBAL CALCULATIONS ---
                if (t.type === 'income') {
                    totalIncome += t.nominal;
                } else {
                    totalExpense += t.nominal;
                }

                // --- WEEKLY BALANCE CALCULATIONS ---
                // Pengurangan pengeluaran harian/mingguan dalam 7 hari terakhir
                if (isExpense && EXPENSE_GROUPS.WEEKLY.includes(t.category) && transactionDate >= oneWeekAgo) {
                    weeklyBalance -= t.nominal;
                } 


                // --- MONTHLY BALANCE CALCULATIONS ---
                // Pengurangan pengeluaran utama/bulanan dalam 30 hari terakhir
                if (isExpense && EXPENSE_GROUPS.MONTHLY.includes(t.category) && transactionDate >= oneMonthAgo) {
                    monthlyBalance -= t.nominal;
                } 
            });

            const totalBalance = totalIncome - totalExpense;

            // Update Global Balances
            document.getElementById('total-income').textContent = formatRupiah(totalIncome);
            document.getElementById('total-expense').textContent = formatRupiah(totalExpense);
            
            const balanceElement = document.getElementById('total-balance');
            balanceElement.textContent = formatRupiah(totalBalance);
            balanceElement.classList.remove('text-red-600', 'text-blue-600');
            balanceElement.classList.add(totalBalance < 0 ? 'text-red-600' : 'text-blue-600');

            // Update Detail Balances (Weekly & Monthly)
            document.getElementById('weekly-balance').textContent = formatRupiah(weeklyBalance);
            document.getElementById('monthly-balance').textContent = formatRupiah(monthlyBalance);
            
            // Tambahkan styling pada saldo mingguan/bulanan
            const weeklyElement = document.getElementById('weekly-balance');
            weeklyElement.classList.remove('text-red-800', 'text-yellow-800');
            weeklyElement.classList.add(weeklyBalance < 0 ? 'text-red-800' : 'text-yellow-800');

            const monthlyElement = document.getElementById('monthly-balance');
            monthlyElement.classList.remove('text-red-800', 'text-indigo-800');
            monthlyElement.classList.add(monthlyBalance < 0 ? 'text-red-800' : 'text-indigo-800');


            updateChart(totalExpense);
        };

        /**
         * Mengupdate grafik Pie Chart.
         */
        const updateChart = (totalExpense) => {
            const expenseByCategories = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.nominal;
                    return acc;
                }, {});

            const chartLabels = Object.keys(expenseByCategories);
            const chartData = Object.values(expenseByCategories);

            // Hapus chart lama jika ada
            if (categoryChart) {
                categoryChart.destroy();
            }

            const ctx = document.getElementById('category-chart').getContext('2d');
            
            // Generate warna dinamis
            const generateColors = (count) => {
                const colors = [];
                for (let i = 0; i < count; i++) {
                    // Warna soft dan cerah
                    const hue = (i * 137.508) % 360; // Sudut emas
                    colors.push(`hsl(${hue}, 70%, 70%)`);
                }
                return colors;
            };

            categoryChart = new Chart(ctx, {
                type: 'pie', // Menggunakan Pie Chart
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Persentase Pengeluaran',
                        data: chartData,
                        backgroundColor: generateColors(chartLabels.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: window.innerWidth < 640 ? 10 : 12 // Ukuran font legend responsif
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = totalExpense > 0 ? ((value / totalExpense) * 100).toFixed(1) : 0;
                                    return `${label}: ${formatRupiah(value)} (${percentage}%)`;
                                }
                            }
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            });
        };

        // --- TRANSACTION LIST FUNCTIONS ---

        /**
         * Menambahkan baris transaksi ke tabel.
         */
        const renderTransactionList = () => {
            const tableBody = document.getElementById('transaction-table-body');
            const noMessage = document.getElementById('no-transactions-message');
            tableBody.innerHTML = ''; // Kosongkan tabel

            if (transactions.length === 0) {
                noMessage.classList.remove('hidden');
                return;
            }
            noMessage.classList.add('hidden');

            transactions.forEach(t => {
                const row = tableBody.insertRow();
                
                let rowBgClass = 'bg-white hover:bg-gray-50 transition';
                if (t.type === 'income') {
                    if (WEEKLY_INCOME_CATS.includes(t.category)) {
                        rowBgClass = 'bg-yellow-50 hover:bg-yellow-100 transition';
                    } else if (MONTHLY_INCOME_CATS.includes(t.category)) {
                        rowBgClass = 'bg-indigo-50 hover:bg-indigo-100 transition';
                    } else {
                        rowBgClass = 'bg-green-50 hover:bg-green-100 transition';
                    }
                } else {
                    // Styling untuk pengeluaran berdasarkan kelompok
                    if (EXPENSE_GROUPS.WEEKLY.includes(t.category)) {
                        rowBgClass = 'bg-red-50/70 hover:bg-red-100 transition'; // Pengeluaran Mingguan
                    } else if (EXPENSE_GROUPS.MONTHLY.includes(t.category)) {
                        rowBgClass = 'bg-pink-50/70 hover:bg-pink-100 transition'; // Pengeluaran Bulanan
                    }
                }
                row.className = rowBgClass;


                // Kolom Tanggal (Short format)
                const dateCell = row.insertCell();
                dateCell.className = 'px-2 py-3 whitespace-nowrap text-xs text-gray-500';
                dateCell.textContent = new Date(t.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });

                // Kolom Catatan
                const noteCell = row.insertCell();
                noteCell.className = 'px-2 py-3 whitespace-normal text-xs sm:text-sm font-medium text-gray-900';
                // Batasi panjang catatan di tampilan HP
                const displayNote = window.innerWidth < 640 && t.note.length > 30 ? t.note.substring(0, 27) + '...' : (t.note || '-');
                noteCell.textContent = displayNote;

                // Kolom Kategori
                const categoryCell = row.insertCell();
                categoryCell.className = 'px-2 py-3 whitespace-nowrap text-xs text-gray-700';
                categoryCell.textContent = t.category;

                // Kolom Nominal
                const nominalCell = row.insertCell();
                nominalCell.className = `px-2 py-3 whitespace-nowrap text-xs sm:text-sm font-semibold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}`;
                // Teks lebih kecil di HP
                nominalCell.textContent = formatRupiah(t.nominal);

                // Kolom Aksi (Edit/Hapus)
                const actionCell = row.insertCell();
                actionCell.className = 'px-2 py-3 whitespace-nowrap text-xs font-medium space-x-1';
                actionCell.innerHTML = `
                    <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition text-xs">
                        Edit
                    </button>
                    <button onclick="openDeleteModal('${t.id}')" class="text-red-600 hover:text-red-900 transition text-xs">
                        Hapus
                    </button>
                `;
            });
        };

        // --- CRUD OPERATIONS ---

        /**
         * Menangani submit form (Tambah atau Edit).
         * @param {Event} e - Event form submit.
         */
        const handleFormSubmit = (e) => {
            e.preventDefault();

            const id = document.getElementById('transaction-id').value;
            const type = document.getElementById('type').value;
            const nominal = parseInt(document.getElementById('nominal').value);
            const date = document.getElementById('date').value;
            const category = document.getElementById('category').value;
            const note = document.getElementById('note').value.trim();

            if (!category) {
                // Tampilkan pesan jika kategori belum dipilih (walaupun sudah required di HTML)
                const categoryElement = document.getElementById('category');
                categoryElement.focus();
                categoryElement.classList.add('border-red-500', 'ring-red-500');
                setTimeout(() => categoryElement.classList.remove('border-red-500', 'ring-red-500'), 2000);
                return;
            }

            const newTransaction = {
                id: id || crypto.randomUUID(), // Gunakan ID yang sudah ada atau buat baru
                type,
                nominal,
                date,
                category,
                note,
                createdAt: id ? transactions.find(t => t.id === id).createdAt : Date.now()
            };

            if (id) {
                // EDIT TRANSAKSI
                const index = transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    transactions[index] = newTransaction;
                }
                resetForm();
            } else {
                // TAMBAH TRANSAKSI BARU
                transactions.push(newTransaction);
                // Reset form setelah simpan
                document.getElementById('transaction-form').reset();
                document.getElementById('date').value = new Date().toISOString().substring(0, 10); // Set tanggal hari ini lagi
            }

            saveTransactions();
            refreshApp();
        };

        /**
         * Mengisi form dengan data transaksi untuk proses edit.
         * @param {string} id - ID transaksi yang akan diedit.
         */
        const editTransaction = (id) => {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // Isi semua field
            document.getElementById('transaction-id').value = transaction.id;
            document.getElementById('type').value = transaction.type;

            // Perlu panggil populateCategories untuk mengisi kategori yang benar berdasarkan tipe
            populateCategories();

            document.getElementById('nominal').value = transaction.nominal;
            document.getElementById('date').value = transaction.date;
            document.getElementById('category').value = transaction.category;
            document.getElementById('note').value = transaction.note;

            // Ganti teks tombol dan tampilkan tombol batal
            document.getElementById('submit-button').textContent = 'Update Transaksi';
            document.getElementById('submit-button').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('submit-button').classList.add('bg-orange-500', 'hover:bg-orange-600');

            document.getElementById('cancel-edit-button').classList.remove('hidden');

            // Scroll ke atas ke form (di HP, form ada di bawah)
            // Scroll ke form input
            const formElement = document.getElementById('transaction-form');
            formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        /**
         * Mereset form input ke kondisi awal.
         */
        const resetForm = () => {
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('submit-button').textContent = 'Simpan Transaksi';
            document.getElementById('submit-button').classList.remove('bg-orange-500', 'hover:bg-orange-600');
            document.getElementById('submit-button').classList.add('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('cancel-edit-button').classList.add('hidden');
            // Pastikan kategori dan tanggal terisi default lagi
            populateCategories();
            document.getElementById('date').value = new Date().toISOString().substring(0, 10);
        };

        /**
         * Menampilkan modal konfirmasi hapus.
         * @param {string} id - ID transaksi yang akan dihapus.
         */
        const openDeleteModal = (id) => {
            const modal = document.getElementById('delete-modal');
            const confirmButton = document.getElementById('confirm-delete-button');

            // HINDARI confirm() BAWAAN BROWSER, Gunakan Modal Kustom
            confirmButton.onclick = () => deleteTransaction(id);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        /**
         * Menyembunyikan modal konfirmasi hapus.
         */
        const closeDeleteModal = () => {
            const modal = document.getElementById('delete-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        /**
         * Menghapus transaksi dari array.
         * @param {string} id - ID transaksi yang akan dihapus.
         */
        const deleteTransaction = (id) => {
            transactions = transactions.filter(t => t.id !== id);
            saveTransactions();
            closeDeleteModal();
            refreshApp();
        };

        // --- PDF EXPORT FUNCTION ---

        /**
         * Mengunduh data transaksi sebagai dokumen PDF (tabel) menggunakan jsPDF.
         */
        const downloadPDF = () => {
            if (transactions.length === 0) {
                // Tampilkan modal pesan jika tidak ada data
                const modalHtml = `
                    <div id="info-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-4" onclick="document.getElementById('info-modal').remove()">
                        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Informasi</h3>
                            <p class="text-gray-600 mb-6">Tidak ada data transaksi untuk diunduh.</p>
                            <div class="flex justify-end">
                                <button type="button" onclick="document.getElementById('info-modal').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Tutup</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                return;
            }

            // Inisialisasi jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Konfigurasi Header Tabel
            const head = [['Tanggal', 'Jenis', 'Kategori', 'Catatan', 'Nominal (Rp)']];

            // Konversi data transaksi ke format yang dapat digunakan autoTable
            const body = transactions.map(t => [
                new Date(t.date).toLocaleDateString('id-ID'),
                t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                t.category,
                t.note || '-',
                formatRupiah(t.nominal)
            ]);
            
            // Hitung total saldo untuk ringkasan (Global)
            let totalIncome = 0;
            let totalExpense = 0;
            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.nominal;
                } else {
                    totalExpense += t.nominal;
                }
            });
            const totalBalance = totalIncome - totalExpense;
            
            // Tentukan periode laporan
            const oldestDate = transactions.length > 0 ? new Date(transactions[transactions.length - 1].date).toLocaleDateString('id-ID') : 'N/A';
            const newestDate = transactions.length > 0 ? new Date(transactions[0].date).toLocaleDateString('id-ID') : 'N/A';

            // Tambahkan judul dokumen
            doc.setFontSize(18);
            doc.text("Laporan Keuangan Pribadi Kadek Adi Mahendra", 14, 22);
            
            doc.setFontSize(10);
            doc.text(`Periode: ${oldestDate} s/d ${newestDate}`, 14, 28);
            
            // Gunakan autoTable untuk membuat tabel
            doc.autoTable({
                head: head,
                body: body,
                startY: 35,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] }, // Biru Tailwind-600
                styles: { fontSize: 9 },
                didDrawPage: function (data) {
                    // Footer halaman
                    doc.setFontSize(8);
                    doc.text("Dibuat menggunakan Buku Kas Digital.", data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            // Ambil posisi akhir tabel
            let finalY = doc.autoTable.previous.finalY;

            // Tambahkan ringkasan keuangan Global di bawah tabel
            doc.setFontSize(10);
            doc.text("Ringkasan Keuangan (Global):", 14, finalY + 10);
            
            doc.setFontSize(12);
            doc.text(`Total Pemasukan: ${formatRupiah(totalIncome)}`, 14, finalY + 18);
            doc.text(`Total Pengeluaran: ${formatRupiah(totalExpense)}`, 14, finalY + 24);
            
            doc.setFontSize(14);
            const balanceText = `Saldo Akhir Global: ${formatRupiah(totalBalance)}`;
            // Warna saldo: Hijau (positif) atau Merah (negatif)
            const balanceColor = totalBalance < 0 ? [220, 38, 38] : [22, 163, 74]; 
            doc.setTextColor(balanceColor[0], balanceColor[1], balanceColor[2]);
            doc.text(balanceText, 14, finalY + 34);
            doc.setTextColor(0, 0, 0); // Reset warna

            // Tambahkan ringkasan saldo periodik
            doc.setFontSize(10);
            doc.text("Catatan: Saldo Periodik dihitung berdasarkan kategori Pemasukan/Pengeluaran dan periode waktu.", 14, finalY + 45);


            // Cek apakah perlu halaman baru untuk ringkasan periodik
            if (finalY + 55 > doc.internal.pageSize.height - 30) {
                doc.addPage();
                finalY = 10;
            } else {
                finalY += 55;
            }
            
            // Hitung dan tampilkan saldo periodik
            const now = new Date();
            const oneWeekAgo = new Date(now); oneWeekAgo.setDate(now.getDate() - 7);
            const oneMonthAgo = new Date(now); oneMonthAgo.setDate(now.getDate() - 30);
            
            let weeklyBalance = 0;
            let monthlyBalance = 0;

            // Hitung Pemasukan Periodik
            transactions.forEach(t => {
                if (t.type === 'income') {
                    if (WEEKLY_INCOME_CATS.includes(t.category)) {
                        weeklyBalance += t.nominal;
                    }
                    if (MONTHLY_INCOME_CATS.includes(t.category)) {
                        monthlyBalance += t.nominal;
                    }
                }
            });

            // Kurangi dengan Pengeluaran Periodik dalam rentang waktu
            transactions.forEach(t => {
                const transactionDate = new Date(t.date);
                const isExpense = t.type === 'expense';
                
                // Weekly Expense
                if (isExpense && EXPENSE_GROUPS.WEEKLY.includes(t.category) && transactionDate >= oneWeekAgo) {
                    weeklyBalance -= t.nominal;
                } 

                // Monthly Expense
                if (isExpense && EXPENSE_GROUPS.MONTHLY.includes(t.category) && transactionDate >= oneMonthAgo) {
                    monthlyBalance -= t.nominal;
                } 
            });


            doc.setFontSize(14);
            doc.text("Saldo Periodik", 14, finalY);

            // Saldo Mingguan
            const weeklyColor = weeklyBalance < 0 ? [220, 38, 38] : [146, 64, 14]; // Merah/Cokelat
            doc.setFontSize(12);
            doc.text("Saldo Mingguan (7 Hari):", 14, finalY + 8);
            doc.setTextColor(weeklyColor[0], weeklyColor[1], weeklyColor[2]);
            doc.text(formatRupiah(weeklyBalance), 65, finalY + 8); // Pindah ke kanan untuk nilai
            
            // Saldo Bulanan
            const monthlyColor = monthlyBalance < 0 ? [220, 38, 38] : [79, 70, 229]; // Merah/Ungu
            doc.setTextColor(0, 0, 0); // Reset warna
            doc.setFontSize(12);
            doc.text("Saldo Bulanan (30 Hari):", 14, finalY + 16);
            doc.setTextColor(monthlyColor[0], monthlyColor[1], monthlyColor[2]);
            doc.text(formatRupiah(monthlyBalance), 65, finalY + 16); // Pindah ke kanan untuk nilai
            
            doc.setTextColor(0, 0, 0); // Reset warna
            
            // Simpan dokumen dengan nama file yang dinamis
            doc.save(`Laporan_Keuangan_Detail_${new Date().toISOString().substring(0, 10)}.pdf`);
        };


        // --- INITIALIZATION AND REFRESH ---

        /**
         * Fungsi untuk memuat ulang semua komponen UI.
         */
        const refreshApp = () => {
            loadTransactions();
            updateDashboard();
            renderTransactionList();
        };

        /**
         * Inisialisasi aplikasi saat dokumen dimuat.
         */
        const init = () => {
            // 1. Set tanggal hari ini di form
            document.getElementById('date').value = new Date().toISOString().substring(0, 10);

            // 2. Isi pilihan kategori
            populateCategories();

            // 3. Tambahkan event listener
            document.getElementById('type').addEventListener('change', populateCategories);
            document.getElementById('transaction-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('cancel-edit-button').addEventListener('click', resetForm);
            document.getElementById('download-pdf-button').addEventListener('click', downloadPDF);

            // 4. Tambahkan listener untuk refresh tabel dan chart saat resize (khusus responsif)
            window.addEventListener('resize', () => {
                renderTransactionList(); // Memperbarui tampilan catatan (truncate)
                updateChart(transactions.filter(t => t.type === 'expense').reduce((a, b) => a + b.nominal, 0)); // Memperbarui chart agar legend responsif
            });

            // 5. Muat dan render data awal
            refreshApp();
        };

        // Jalankan inisialisasi
        window.onload = init;
    </script>

</body>
</html>